# The name of the workflow.
# GitHub displays the names of your workflows under your repository's "Actions" tab.
name: Build

# The name for workflow runs generated from the workflow.
# GitHub displays the workflow run name in the list of workflow runs on your repository's "Actions" tab.
run-name: "[Build] ${{ github.ref }}"

on:
  workflow_dispatch:

jobs:
  linux:
    name: ${{ matrix.os }}-${{ matrix.compiler.cc }}-${{ matrix.compiler.version }}-${{ matrix.buildConfig }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # if one job in the matrix fail, don't cancel other jobs inthe matrix
      matrix:
        os: [ ubuntu-22.04, ubuntu-24.04]
        buildConfig: [Debug, Release, RelWithDebInfo]
        compiler:
          - { cc: gcc, cxx: g++, version: 10}
          - { cc: gcc, cxx: g++, version: 11}
          - { cc: gcc, cxx: g++, version: 12}
          - { cc: gcc, cxx: g++, version: 13}
          - { cc: gcc, cxx: g++, version: 14}
          - { cc: clang, cxx: clang++, version: 13 }
          - { cc: clang, cxx: clang++, version: 14 }
          - { cc: clang, cxx: clang++, version: 15 }
          - { cc: clang, cxx: clang++, version: 16 }
          - { cc: clang, cxx: clang++, version: 17 }
          - { cc: clang, cxx: clang++, version: 18 }
        exclude:
            - os : ubuntu-22.04
              compiler: { cc: gcc, cxx: g++, version: 12}
            - os : ubuntu-22.04
              compiler: { cc: gcc, cxx: g++, version: 13}
            - os : ubuntu-22.04
              compiler: { cc: gcc, cxx: g++, version: 14}
            - os : ubuntu-22.04
              compiler: { cc: clang, cxx: clang++, version: 16}
            - os : ubuntu-22.04
              compiler: { cc: clang, cxx: clang++, version: 17}
            - os : ubuntu-22.04
              compiler: { cc: clang, cxx: clang++, version: 18}
            - os : ubuntu-24.04
              compiler: { cc: gcc, cxx: g++, version: 10}
            - os : ubuntu-24.04
              compiler: { cc: gcc, cxx: g++, version: 11}
            - os : ubuntu-24.04
              compiler: { cc: clang, cxx: clang++, version: 13}
            - os : ubuntu-24.04
              compiler: { cc: clang, cxx: clang++, version: 14}
            - os : ubuntu-24.04
              compiler: { cc: clang, cxx: clang++, version: 15}
    env:
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
    steps:
      - name: Install libltdl-dev
        run: sudo apt-get install libltdl-dev
      - run: sudo apt-get install ninja-build

      # Clone the repo
      - name: Cloning git repo
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      # Setup vcpkg: ensures vcpkg is downloaded and built.
      # Since vcpkg.json is being used later on to install the packages
      # when `run-cmake` runs, no packages are installed at this time
      # (and vcpkg does not run).
      - name: Setup a new (or from cache) vcpkg (and does not build any package)
        uses: lukka/run-vcpkg@v11
        id: runvcpkg
        env:
          VCPKG_INSTALLED_DIR: ${{ github.workspace }}/vcpkg_installed
        with:
          runVcpkgInstall: true

      - name: Running cmake configure ...
        env:
          CC: "${{ matrix.compiler.cc }}-${{ matrix.compiler.version }}"
          CXX: "${{ matrix.compiler.cxx }}-${{ matrix.compiler.version }}"
          CMAKE_GENERATOR: "Ninja"
          CMAKE_BUILD_TYPE: "${{ matrix.buildConfig }}"
        run: |
          cmake -S . -B ./build \
            -DCMAKE_MODULE_PATH=${{ github.workspace }}/vcpkg_installed/${{ steps.runvcpkg.outputs.RUNVCPKG_VCPKG_DEFAULT_TRIPLET_OUT }}  \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/vcpkg_installed/${{ steps.runvcpkg.outputs.RUNVCPKG_VCPKG_DEFAULT_TRIPLET_OUT }}

      - name: Running cmake build ...
        run: cmake --build ./build

      - name: Running tests ...
        run: ctest --test-dir ./build

      - name: Running cmake install ...
        run: cmake --install ./build --prefix ./install

  osx:
    name: ${{ matrix.os }}-${{ matrix.compiler.cc }}-${{ matrix.compiler.version }}-${{ matrix.buildConfig }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # if one job in the matrix fail, don't cancel other jobs inthe matrix
      matrix:
        os: [ macos-13, macos-14, macos-15 ]
        buildConfig: [Debug, Release]
        compiler:
          - { cc: clang, cxx: clang++, version: 14} # 14.0.0
          - { cc: clang, cxx: clang++, version: 15} # 15.0.7
          - { cc: clang, cxx: clang++, version: 18} # 18.1.8
          - { cc: gcc, cxx: g++, version: 12} # GCC 12.4.0   (June 20, 2024)
          - { cc: gcc, cxx: g++, version: 13} # GCC 13.3.0   (May 21, 2024)
          - { cc: gcc, cxx: g++, version: 14} # GCC 14.2.0   (August 1, 2024)
        exclude:
            - os : macos-13
              compiler: { cc: clang, cxx: clang++, version: 18 }
            - os : macos-14
              compiler: { cc: clang, cxx: clang++, version: 14 }
            - os : macos-14
              compiler: { cc: clang, cxx: clang++, version: 18 }
            - os : macos-15
              compiler: { cc: clang, cxx: clang++, version: 14 }
            - os : macos-15
              compiler: { cc: gcc, cxx: g++, version: 12 }
            - os : macos-15
              compiler: { cc: gcc, cxx: g++, version: 13 }
            - os : macos-15
              compiler: { cc: gcc, cxx: g++, version: 14 }
    env:
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
    steps:
        # Osx does not have Ninja installed.
        # CMake should used make but vcpkg fail to build on macos-14 and macos-15
        # beacause cmake canèt find Ninja....
      - name: Installing ninja
        run: |
            brew install ninja

      - run: clang          --version
      - run: /usr/bin/clang --version
      - run: gcc            --version
      - run: /usr/bin/gcc   --version
      - run: ls -la /usr/bin/gcc
      - run: ls -la /usr/bin/clang
      - run: ls -la /usr/local/opt/ || echo ""
      - run: ls -la /usr/local/opt/ || echo ""
      - run: echo $PATH
      - run: echo "$(brew --prefix llvm)/bin/clang"
      - run: echo "$(brew --prefix llvm@15)/bin/clang"
      - run: echo "$(brew --prefix llvm@18)/bin/"


      # Clone the repo
      - name: Cloning git repo
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      # Setup vcpkg: ensures vcpkg is downloaded and built.
      # Since vcpkg.json is being used later on to install the packages
      # when `run-cmake` runs, no packages are installed at this time
      # (and vcpkg does not run).
      - if: startsWith( matrix.compiler.cc, 'gcc')
        name: aaa
        uses: lukka/run-vcpkg@v11
        id: runvcpkg1
        env:
          CC: "${{ matrix.compiler.cc }}-${{ matrix.compiler.version }}"
          CXX: "${{ matrix.compiler.cxx }}-${{ matrix.compiler.version }}"
          VCPKG_INSTALLED_DIR: ${{ github.workspace }}/vcpkg_installed
        with:
            runVcpkgInstall: true

      - if: startsWith(${{ matrix.compiler.cc }}, 'clang')
        name: Setup a new (or from cache) vcpkg (and does not build any package)
        uses: lukka/run-vcpkg@v11
        id: runvcpkg
        env:
          VCPKG_INSTALLED_DIR: ${{ github.workspace }}/vcpkg_installed
        with:
          runVcpkgInstall: true

      - name: Running cmake configure ...
        env:
          CMAKE_GENERATOR: "Ninja"
          CMAKE_BUILD_TYPE: "${{ matrix.buildConfig }}"
        run: |
          # Try to find clang path
          if [[ ${{ matrix.compiler.cc }} == "clang" ]];
          then
            if [[ ${{ matrix.os }} == "macos-15" && ${{  matrix.compiler.version }} == "18" ]];
            then
              export CC=$(brew --prefix llvm@${{  matrix.compiler.version }})/bin/clang
              export CXX=$(brew --prefix llvm@${{  matrix.compiler.version }})/bin/clang++
            elif [[ ${{ matrix.os }} == "macos-14" && ${{  matrix.compiler.version }} == "15" ]];
            then
              export CC=$(brew --prefix llvm@${{  matrix.compiler.version }})/bin/clang
              export CXX=$(brew --prefix llvm@${{  matrix.compiler.version }})/bin/clang++
            elif [[ ${{ matrix.os }} == "macos-13" && ${{  matrix.compiler.version }} == "15" ]];
            then
              export CC=$(brew --prefix llvm@${{  matrix.compiler.version }})/bin/clang
              export CXX=$(brew --prefix llvm@${{  matrix.compiler.version }})/bin/clang++
            else
              export CC=/usr/bin/clang
              export CXX=/usr/bin/clang++
            fi
          else
              export CC="${{ matrix.compiler.cc }}-${{ matrix.compiler.version }}"
              export CXX="${{ matrix.compiler.cxx }}-${{ matrix.compiler.version }}"
          fi

          cmake -S . -B ./build \
            -DCMAKE_MODULE_PATH=${{ github.workspace }}/vcpkg_installed/${{ steps.runvcpkg.outputs.RUNVCPKG_VCPKG_DEFAULT_TRIPLET_OUT }}  \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/vcpkg_installed/${{ steps.runvcpkg.outputs.RUNVCPKG_VCPKG_DEFAULT_TRIPLET_OUT }}

      - name: Running cmake build ...
        run: cmake --build ./build

      - name: Running tests ...
        run: ctest --test-dir ./build

      - name: Running cmake install ...
        run: cmake --install ./build --prefix ./install
